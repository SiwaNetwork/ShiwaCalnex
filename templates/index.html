<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenTimeInstrument - Web Interface</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .measurement-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        
        .measurement-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-inactive {
            background-color: #dc3545;
        }
        
        .measurement-active {
            background-color: #28a745 !important;
            color: white !important;
        }
        
        .measurement-inactive {
            background-color: #6c757d !important;
            color: white !important;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .graph-container {
            height: 400px;
            margin-bottom: 20px;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .control-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .card-custom {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .channel-badge {
            font-size: 0.9em;
            padding: 0.4em 0.8em;
        }
        
        .stats-table {
            font-size: 0.9em;
        }
        
        .btn-custom {
            border-radius: 6px;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-clock me-2"></i>
                OpenTimeInstrument
            </a>
            <span class="navbar-text">
                <span id="connection-status" class="status-indicator status-inactive"></span>
                <span id="connection-text">–û—Ç–∫–ª—é—á–µ–Ω</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Control Panel -->
            <div class="col-lg-3">
                <div class="card card-custom control-panel p-4 mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-cogs me-2"></i>
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    </h5>
                    
                    <!-- Device Selection -->
                    <div class="mb-3">
                        <label for="device-select" class="form-label">PTP –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</label>
                        <select id="device-select" class="form-select">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ...</option>
                            {% for device in devices %}
                            <option value="{{ device.path }}" 
                                    {% if not device.accessible %}disabled{% endif %}
                                    {% if device.path == '/dev/demo' %}selected{% endif %}>
                                {% if device.path == '/dev/demo' %}
                                    üéØ –î–ï–ú–û –†–ï–ñ–ò–ú (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                                {% else %}
                                    {{ device.path }} 
                                    {% if not device.accessible %}(–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ){% endif %}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Control Buttons -->
                    <div class="d-grid gap-2">
                        <button id="start-btn" class="btn btn-success btn-custom">
                            <i class="fas fa-play me-2"></i>
                            –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏—è
                        </button>
                        <button id="stop-btn" class="btn btn-danger btn-custom" disabled>
                            <i class="fas fa-stop me-2"></i>
                            –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏—è
                        </button>
                        <button id="clear-btn" class="btn btn-warning btn-custom">
                            <i class="fas fa-trash me-2"></i>
                            –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                        <button id="export-btn" class="btn btn-info btn-custom">
                            <i class="fas fa-download me-2"></i>
                            –≠–∫—Å–ø–æ—Ä—Ç CSV
                        </button>
                    </div>
                    
                    <!-- Status -->
                    <div class="mt-4">
                        <h6>–°—Ç–∞—Ç—É—Å:</h6>
                        <div id="status-text" class="small">
                            –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Panel -->
                <div class="card card-custom">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="stats-container">
                            <!-- Statistics will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Graphs -->
            <div class="col-lg-9">
                <!-- Real-time Graph -->
                <div class="card card-custom mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            –ò–∑–º–µ—Ä–µ–Ω–∏—è TIE –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="realtime-graph" class="graph-container"></div>
                    </div>
                </div>
                
                <!-- Individual Channel Graphs -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card card-custom">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <span class="badge bg-primary channel-badge me-2">–ö–∞–Ω–∞–ª 1</span>
                                    SMA1
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="channel1-graph" class="graph-container"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card card-custom">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <span class="badge bg-success channel-badge me-2">–ö–∞–Ω–∞–ª 2</span>
                                    SMA2
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="channel2-graph" class="graph-container"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card card-custom">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <span class="badge bg-warning channel-badge me-2">–ö–∞–Ω–∞–ª 3</span>
                                    SMA3
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="channel3-graph" class="graph-container"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card card-custom">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <span class="badge bg-danger channel-badge me-2">–ö–∞–Ω–∞–ª 4</span>
                                    SMA4
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="channel4-graph" class="graph-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // State variables
        let measurementActive = false;
        let channelData = {
            1: { values: [], timestamps: [], stats: { count: 0, min: null, max: null, avg: 0 } },
            2: { values: [], timestamps: [], stats: { count: 0, min: null, max: null, avg: 0 } },
            3: { values: [], timestamps: [], stats: { count: 0, min: null, max: null, avg: 0 } },
            4: { values: [], timestamps: [], stats: { count: 0, min: null, max: null, avg: 0 } }
        };
        
        // Colors for channels
        const channelColors = {
            1: '#007bff',
            2: '#28a745',
            3: '#ffc107',
            4: '#dc3545'
        };
        
        // Initialize graphs
        function initializeGraphs() {
            // Real-time graph
            const realtimeLayout = {
                title: '–í—Å–µ –∫–∞–Ω–∞–ª—ã',
                xaxis: { title: '–í—Ä–µ–º—è' },
                yaxis: { title: 'TIE (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)' },
                showlegend: true,
                autosize: true,
                margin: { l: 50, r: 50, t: 50, b: 50 }
            };
            
            Plotly.newPlot('realtime-graph', [], realtimeLayout, {responsive: true});
            
            // Individual channel graphs
            for (let i = 1; i <= 4; i++) {
                const layout = {
                    title: `–ö–∞–Ω–∞–ª ${i}`,
                    xaxis: { title: '–í—Ä–µ–º—è' },
                    yaxis: { title: 'TIE (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)' },
                    showlegend: false,
                    autosize: true,
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                };
                
                Plotly.newPlot(`channel${i}-graph`, [], layout, {responsive: true});
            }
        }
        
        // Update graphs with new data
        function updateGraphs() {
            console.log('Updating graphs...');
            
            // Update real-time graph with all channels
            const realtimeTraces = [];
            for (let channel = 1; channel <= 4; channel++) {
                if (channelData[channel].values.length > 0) {
                    console.log(`Channel ${channel} data:`, channelData[channel].values.length, 'points');
                    realtimeTraces.push({
                        x: channelData[channel].timestamps,
                        y: channelData[channel].values,
                        name: `–ö–∞–Ω–∞–ª ${channel}`,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: channelColors[channel] },
                        marker: { size: 4 }
                    });
                }
            }
            
            if (realtimeTraces.length > 0) {
                Plotly.react('realtime-graph', realtimeTraces, {
                    title: '–í—Å–µ –∫–∞–Ω–∞–ª—ã',
                    xaxis: { title: '–í—Ä–µ–º—è' },
                    yaxis: { title: 'TIE (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)' },
                    showlegend: true,
                    autosize: true,
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                });
            }
            
            // Update individual channel graphs
            for (let channel = 1; channel <= 4; channel++) {
                if (channelData[channel].values.length > 0) {
                    const trace = [{
                        x: channelData[channel].timestamps,
                        y: channelData[channel].values,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: channelColors[channel] },
                        marker: { size: 4 }
                    }];
                    
                    Plotly.react(`channel${channel}-graph`, trace, {
                        title: `–ö–∞–Ω–∞–ª ${channel}`,
                        xaxis: { title: '–í—Ä–µ–º—è' },
                        yaxis: { title: 'TIE (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)' },
                        showlegend: false,
                        autosize: true,
                        margin: { l: 50, r: 50, t: 50, b: 50 }
                    });
                }
            }
        }
        
        // Update statistics display
        function updateStatistics() {
            console.log('Updating statistics...');
            const container = document.getElementById('stats-container');
            let html = '';
            
            for (let channel = 1; channel <= 4; channel++) {
                const stats = channelData[channel].stats;
                const color = channelColors[channel];
                
                console.log(`Channel ${channel} stats:`, stats);
                
                html += `
                    <div class="mb-3">
                        <h6 style="color: ${color};">
                            <i class="fas fa-circle me-2"></i>
                            –ö–∞–Ω–∞–ª ${channel}
                        </h6>
                        <table class="table table-sm stats-table">
                            <tr>
                                <td>–ò–∑–º–µ—Ä–µ–Ω–∏–π:</td>
                                <td><strong>${stats.count}</strong></td>
                            </tr>
                            <tr>
                                <td>–ú–∏–Ω–∏–º—É–º:</td>
                                <td>${stats.min !== null ? stats.min + ' –Ω—Å' : '--'}</td>
                            </tr>
                            <tr>
                                <td>–ú–∞–∫—Å–∏–º—É–º:</td>
                                <td>${stats.max !== null ? stats.max + ' –Ω—Å' : '--'}</td>
                            </tr>
                            <tr>
                                <td>–°—Ä–µ–¥–Ω–µ–µ:</td>
                                <td>${stats.avg !== 0 ? stats.avg.toFixed(2) + ' –Ω—Å' : '--'}</td>
                            </tr>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            console.log('Statistics updated');
        }
        
        // Socket event handlers
        socket.on('connect', function() {
            document.getElementById('connection-status').className = 'status-indicator status-active';
            document.getElementById('connection-text').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
        });
        
        socket.on('disconnect', function() {
            document.getElementById('connection-status').className = 'status-indicator status-inactive';
            document.getElementById('connection-text').textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
        });
        
        socket.on('measurement_update', function(data) {
            const channel = data.channel;
            const value = data.value;
            const timestamp = new Date(data.timestamp);
            
            // Update data
            channelData[channel].values.push(value);
            channelData[channel].timestamps.push(timestamp);
            channelData[channel].stats = data.stats;
            
            // Keep only last 1000 points
            if (channelData[channel].values.length > 1000) {
                channelData[channel].values.shift();
                channelData[channel].timestamps.shift();
            }
            
            // Update displays
            updateGraphs();
            updateStatistics();
        });
        
        socket.on('data_cleared', function() {
            console.log('Data cleared event received');
            // Clear all data
            for (let channel = 1; channel <= 4; channel++) {
                channelData[channel] = {
                    values: [],
                    timestamps: [],
                    stats: { count: 0, min: null, max: null, avg: 0 }
                };
            }
            
            // Clear graphs by plotting empty data
            Plotly.react('realtime-graph', [], {
                title: '–í—Å–µ –∫–∞–Ω–∞–ª—ã',
                xaxis: { title: '–í—Ä–µ–º—è' },
                yaxis: { title: 'TIE (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)' },
                showlegend: true,
                autosize: true,
                margin: { l: 50, r: 50, t: 50, b: 50 }
            });
            
            // Clear individual channel graphs
            for (let i = 1; i <= 4; i++) {
                Plotly.react(`channel${i}-graph`, [], {
                    title: `–ö–∞–Ω–∞–ª ${i}`,
                    xaxis: { title: '–í—Ä–µ–º—è' },
                    yaxis: { title: 'TIE (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)' },
                    showlegend: false,
                    autosize: true,
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                });
            }
            
            updateStatistics();
        });
        
        // Button event handlers
        document.getElementById('start-btn').addEventListener('click', function() {
            const devicePath = document.getElementById('device-select').value;
            if (!devicePath) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ PTP —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ');
                return;
            }
            
            fetch('/api/start_measurement', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_path: devicePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    measurementActive = true;
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('start-btn').className = 'btn btn-success measurement-active';
                    document.getElementById('stop-btn').disabled = false;
                    document.getElementById('stop-btn').className = 'btn btn-danger';
                    document.getElementById('status-text').textContent = '–ò–∑–º–µ—Ä–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã';
                    
                    // Clear previous data
                    for (let channel = 1; channel <= 4; channel++) {
                        channelData[channel] = {
                            values: [],
                            timestamps: [],
                            stats: { count: 0, min: null, max: null, avg: 0 }
                        };
                    }
                    
                    // Initialize graphs
                    updateGraphs();
                    updateStatistics();
                    
                    console.log('Measurement started successfully');
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–∑–º–µ—Ä–µ–Ω–∏–π: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            });
        });
        
        document.getElementById('stop-btn').addEventListener('click', function() {
            fetch('/api/stop_measurement', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    measurementActive = false;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('start-btn').className = 'btn btn-primary';
                    document.getElementById('stop-btn').disabled = true;
                    document.getElementById('stop-btn').className = 'btn btn-secondary measurement-inactive';
                    document.getElementById('status-text').textContent = '–ò–∑–º–µ—Ä–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            });
        });
        
        document.getElementById('clear-btn').addEventListener('click', function() {
            console.log('Clear button clicked');
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
                console.log('User confirmed clear action');
                fetch('/api/clear_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    console.log('Clear data response:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Clear data result:', data);
                    if (data.success) {
                        console.log('Clear data request successful - clearing local data');
                        // Clear data immediately in case WebSocket event doesn't arrive
                        for (let channel = 1; channel <= 4; channel++) {
                            channelData[channel] = {
                                values: [],
                                timestamps: [],
                                stats: { count: 0, min: null, max: null, avg: 0 }
                            };
                        }
                        
                        console.log('Clearing graphs...');
                        // Clear graphs by plotting empty data
                        Plotly.react('realtime-graph', [], {
                            title: '–í—Å–µ –∫–∞–Ω–∞–ª—ã',
                            xaxis: { title: '–í—Ä–µ–º—è' },
                            yaxis: { title: 'TIE (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)' },
                            showlegend: true,
                            autosize: true,
                            margin: { l: 50, r: 50, t: 50, b: 50 }
                        });
                        
                        // Clear individual channel graphs
                        for (let i = 1; i <= 4; i++) {
                            Plotly.react(`channel${i}-graph`, [], {
                                title: `–ö–∞–Ω–∞–ª ${i}`,
                                xaxis: { title: '–í—Ä–µ–º—è' },
                                yaxis: { title: 'TIE (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)' },
                                showlegend: false,
                                autosize: true,
                                margin: { l: 50, r: 50, t: 50, b: 50 }
                            });
                        }
                        
                        console.log('Updating statistics...');
                        updateStatistics();
                        console.log('Clear operation completed');
                    } else {
                        console.error('Clear data failed:', data);
                        alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                });
            } else {
                console.log('User cancelled clear action');
            }
        });
        
        document.getElementById('export-btn').addEventListener('click', function() {
            window.location.href = '/api/export_data';
        });
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initializeGraphs();
            updateStatistics();
            
            // Start periodic data updates if WebSocket is not working
            setInterval(function() {
                if (measurementActive) {
                    fetch('/api/measurement_data')
                        .then(response => response.json())
                        .then(data => {
                            console.log('Received data update:', Object.keys(data));
                            // Update channel data from server
                            let hasNewData = false;
                            for (let channel = 1; channel <= 4; channel++) {
                                const channelKey = `channel_${channel}`;
                                if (data[channelKey] && data[channelKey].values) {
                                    const newValues = data[channelKey].values;
                                    const newTimestamps = data[channelKey].timestamps.map(t => new Date(t));
                                    
                                    // Check if we have new data
                                    if (newValues.length !== channelData[channel].values.length) {
                                        hasNewData = true;
                                        console.log(`Channel ${channel} new data:`, newValues.length - channelData[channel].values.length, 'new points');
                                    }
                                    
                                    channelData[channel].values = newValues;
                                    channelData[channel].timestamps = newTimestamps;
                                    channelData[channel].stats = data[channelKey].stats;
                                }
                            }
                            
                            if (hasNewData) {
                                updateGraphs();
                                updateStatistics();
                            }
                        })
                        .catch(error => console.error('Error fetching data:', error));
                }
            }, 500); // Update every 500ms for smoother animation
        });
    </script>
</body>
</html>